### 孤立森林Isolation Forest__异常检测算法

> 孤立(Isolation)指“把异常点从所有样本中孤立出来”，separating an instance from the rest of the instances

#### 异常点的定义

> 容易被孤立的离群点，分布稀疏，且距离高密度群体较远的点。从统计来看，在数据空间里，若一个区域内只有分布稀疏的点，表示数据点落在此区域的概率很低，因此可认为这些区域的点是异常的

* 孤立森林算法的理论基础有两点：

  * 异常数据占总样本量的比例很小
  * 异常点的特征值与正常点的差异很大

* 应用场景

  * 网络安全中的攻击检测
  * 金融交易欺诈检测
  * 疾病侦测
  * 噪声数据过滤(数据清洗)

* 算法创新点

  * Partial models：在训练过程中，每棵孤立树都是随机选取部分样本
  * No distance or density measures：不同与kmeans、dbscan等算法，孤立森林不需要计算有关距离、密度的指标，可大幅提升速度，减少系统开销
  * Linear time complexity：基于ensemble，所以线性时间复杂度，通常树的数量越多，算法越稳定

* 算法思想

  > 用一个随机超平面对一个数据空间进行切割，切一次可以生成两个子空间，再继续随机选取超平面，来切割第一步得到的两个子空间，以此循环下去，直到每子空间里面只包含一个数据点为止。
  >
  > 可以发现，那些密度很高的簇要被切很多次才会停止切割，即每个点都单独存在于一个子空间内，但那些分布稀疏的点，大都很早就停到一个子空间内了。



#### 训练-测试过程

* 单颗树的训练

  1. 从训练数据中随机选择Ψ个点作为子样本，放入一颗孤立树的根节点
  2. 随机指定一个维度，在当前节点数据范围内，随机产生一个切割点 p —— 切割点产生于当前节点数据中指定维度的最大值与最小值之间
  3. 此切割点的选取生成了一个超平面，将当前节点数据空间切分为2个子空间：把当前所选维度下小于 p 的点放在当前节点的左分支，把大于等于 p 的点放在当前节点的右分支
  4. 在节点的左分支和右分支节点递归步骤 2、3，不断构造新的叶子节点，直到叶子节点上只有一个数据（无法再继续切割） 或树已经生长到了所设定的高度

* 整合全部孤立树的结果

  > 由于切割过程是完全随机的，所以需要用 ensemble（baggin:使用训练数据的不同随机子集来训练g） 的方法来使结果收敛，即反复从头开始切，然后计算每次切分结果的平均值；获得 t 个孤立树后，单棵树的训练就结束了。接下来就可以用生成的孤立树来评估测试数据了，即计算异常分数 s。 对于每个样本 x，需要对其综合计算每棵树的结果，通过下面的公式计算异常得分

$$
\LARGE s(x,\Psi) = 2^{-\frac{E(h(x))}{c(\Psi)}}
$$

h(x)为x在每棵树的高度，c($\Psi$)为给定样本数$\Psi$时路径长度的平均值，用来对样本x的路径长度h(x)进行标准化处理

孤立树的数目与每个样本点的平均高度的关系，可以看到数目选取在 10 以内时，结果非常不稳定，当数目达到 100 后就趋于收敛了。因此我们在使用过程中，树的棵树设置为 100 即可，如果棵树过少结果可能不稳定，若过多则白白浪费了系统开销

#### 异常得分

* 如果异常得分接近1，那么一定是异常点

* 如果异常得分远小于 0.5，那么一定不是异常点

* 如果异常得分所有点的得分都在 0.5 左右，那么样本中很可能不存在异常点

  

#### 算法主要分两步：

* 训练iF：从训练集中进行采样，构建孤立树，对森林中的每颗孤立树进行测试，记录路径长度
* 计算异常分数：根据分数计算公式，计算每个样本点anomaly score



#### 总结　　

- iForest具有**线性时间复杂度**，因为是ensemble的方法，所以可以用在含有海量数据的数据集上面，通常树的数量越多，算法越稳定。由于每棵树都是相互独立生成的，因此可以部署在大规模分布式系统上来加速运算。
- iForest**不适用于特别高维的数据**。由于每次切数据空间都是随机选取一个维度，建完树后仍然有大量的维度信息没有被使用，导致算法可靠性降低。高维空间还可能存在大量噪音维度或者无关维度（irrelevant attributes），影响树的构建。对这类数据，建议使用子空间异常检测（Subspace Anomaly Detection）技术。此外，切割平面默认是axis-parallel的，也可以随机生成各种角度的切割平面。
- IForest仅对**Global Anomaly**敏感，即全局稀疏点敏感，不擅长处理局部的相对稀疏点（Local Anomaly）。
- iForest推动了**重心估计**（Mass Estimation）理论，目前在分类聚类和异常检测中都取得显著效果。































